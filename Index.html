Add the code to this-<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ORBIT">
    <meta name="theme-color" content="#000000">
    <title>ORBIT</title>

    <!-- PWA -->
    <link rel="manifest" href="./manifest.webmanifest">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=SF+Pro+Rounded:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);

            --bg0: #000;
            --bg1: #0a0a0c;
            --bg2: #0f0f12;

            --hair: rgba(255, 255, 255, 0.10);
            --hair2: rgba(255, 255, 255, 0.07);

            --card: rgba(255, 255, 255, 0.065);
            --card2: rgba(255, 255, 255, 0.055);

            --text: rgba(255, 255, 255, 0.92);
            --sub: rgba(255, 255, 255, 0.62);
            --muted: rgba(255, 255, 255, 0.48);

            --blue: #6478ff;
            --violet: #a078ff;
            --green: #50dc78;
            --orange: #ffb464;
            --cyan: #64c8ff;

            --radius: 18px;
            --radius2: 14px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation; /* reduce accidental dbl-tap zoom without hijacking scroll */
            background: #000;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Rounded', sans-serif;
            background: linear-gradient(180deg, var(--bg0) 0%, var(--bg1) 50%, var(--bg2) 100%);
            color: var(--text);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            overscroll-behavior: none;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: -webkit-fill-available;
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }

        /* Apple-like sticky blur header behind capsule + summary */
        .header {
            position: sticky;
            top: 0;
            z-index: 25;
            padding: 10px 16px 8px;
            background: linear-gradient(180deg, rgba(0,0,0,0.82) 0%, rgba(0,0,0,0.55) 55%, rgba(0,0,0,0.0) 100%);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
        }

        /* Top Capsule - Dynamic Island Style */
        .capsule-container {
            display: flex;
            justify-content: center;
            padding: 2px 0 6px;
            flex-shrink: 0;
        }

        .capsule {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(30, 30, 35, 0.82);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 999px;
            transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
            will-change: transform, width, height;
        }

        .capsule::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.03) 50%, transparent 100%);
            border-radius: inherit;
            pointer-events: none;
        }

        .capsule.idle {
            width: 170px;
            height: 36px;
            box-shadow: 0 6px 26px rgba(255, 255, 255, 0.06);
        }

        .capsule.planning {
            width: 270px;
            height: 44px;
            box-shadow: 0 10px 46px rgba(100, 120, 255, 0.25);
            border-color: rgba(100, 120, 255, 0.32);
        }

        .capsule.adapting {
            width: 250px;
            height: 42px;
            box-shadow: 0 10px 46px rgba(255, 180, 100, 0.2);
            border-color: rgba(255, 180, 100, 0.28);
        }

        .capsule.success {
            width: 190px;
            height: 38px;
            box-shadow: 0 8px 34px rgba(80, 220, 120, 0.22);
            border-color: rgba(80, 220, 120, 0.28);
        }

        .capsule.focused {
            width: 210px;
            height: 40px;
            box-shadow: 0 8px 34px rgba(100, 200, 255, 0.18);
            border-color: rgba(100, 200, 255, 0.26);
        }

        .capsule-content {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 16px;
            font-size: 13px;
            font-weight: 600;
            letter-spacing: 0.2px;
            color: rgba(255, 255, 255, 0.9);
            z-index: 1;
        }

        .capsule-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            transition: all 0.35s ease;
        }

        .capsule.planning .capsule-dot {
            background: var(--blue);
            box-shadow: 0 0 12px var(--blue);
            animation: pulse-dot 1s ease-in-out infinite;
        }
        .capsule.adapting .capsule-dot { background: var(--orange); box-shadow: 0 0 12px var(--orange); }
        .capsule.success .capsule-dot { background: var(--green); box-shadow: 0 0 12px var(--green); }
        .capsule.focused .capsule-dot { background: var(--cyan); box-shadow: 0 0 12px var(--cyan); }

        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--blue), var(--violet));
            border-radius: 0 0 999px 999px;
            transition: width 0.12s linear;
        }

        /* Capsule shimmer when planning */
        @keyframes shimmer {
            0% { background-position: -220% 0; }
            100% { background-position: 220% 0; }
        }

        .capsule.planning::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.10), transparent);
            background-size: 220% 100%;
            animation: shimmer 2s infinite;
            border-radius: inherit;
        }

        /* Day Summary */
        .day-summary {
            text-align: center;
            padding: 6px 0 8px;
            opacity: 0;
            transform: translateY(-8px);
            transition: all 0.35s ease;
        }

        .day-summary.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .day-summary h2 {
            font-size: 15px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.88);
            margin-bottom: 4px;
        }

        .day-summary .confidence {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.52);
        }

        /* Timeline wrapper with scroll edge fades */
        .timeline-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 6px 16px 18px;
            -webkit-overflow-scrolling: touch;
            position: relative;
        }

        .timeline-container::before,
        .timeline-container::after {
            content: '';
            position: sticky;
            left: 0;
            right: 0;
            height: 18px;
            pointer-events: none;
            z-index: 10;
            display: block;
        }
        .timeline-container::before {
            top: 0;
            background: linear-gradient(180deg, rgba(0,0,0,0.60), rgba(0,0,0,0.0));
        }
        .timeline-container::after {
            bottom: 0;
            background: linear-gradient(0deg, rgba(0,0,0,0.70), rgba(0,0,0,0.0));
        }

        .timeline {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-bottom: 8px;
        }

        .block-card {
            position: relative;
            display: flex;
            gap: 12px;
            padding: 16px;
            background: var(--card2);
            border: 1px solid var(--hair2);
            border-radius: var(--radius);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);

            transition: opacity 0.45s ease, transform 0.45s ease, border-color 0.35s ease, box-shadow 0.35s ease, filter 0.35s ease;
            cursor: pointer;
            transform-origin: center;

            opacity: 0;
            transform: translateY(14px);
            user-select: none;
            -webkit-user-select: none;
        }

        .block-card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Subtle iOS-like press highlight (instead of scaling down the whole card) */
        .block-card::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: rgba(255, 255, 255, 0.06);
            opacity: 0;
            transition: opacity 0.18s ease;
            pointer-events: none;
        }
        .block-card:active::after { opacity: 1; }

        .block-card.dimmed {
            opacity: 0.22;
            filter: blur(1px);
        }

        .block-card.focused-block {
            border-color: rgba(100, 200, 255, 0.40);
            box-shadow: 0 10px 34px rgba(100, 200, 255, 0.14);
        }

        .block-card.current {
            border-color: rgba(255, 255, 255, 0.18);
            box-shadow: 0 0 34px rgba(255, 255, 255, 0.08);
        }

        @keyframes breathe {
            0%, 100% { box-shadow: 0 0 22px rgba(255, 255, 255, 0.05); }
            50% { box-shadow: 0 0 34px rgba(255, 255, 255, 0.10); }
        }
        .block-card.current { animation: breathe 3s ease-in-out infinite; }

        /* Block type colors */
        .block-card.routine {
            background: linear-gradient(135deg, rgba(255, 160, 80, 0.14) 0%, rgba(255, 200, 100, 0.06) 100%);
        }
        .block-card.fixed {
            background: linear-gradient(135deg, rgba(160, 100, 220, 0.16) 0%, rgba(120, 80, 200, 0.08) 100%);
        }
        .block-card.rest {
            background: linear-gradient(135deg, rgba(80, 200, 120, 0.13) 0%, rgba(100, 220, 160, 0.06) 100%);
        }
        .block-card.focus {
            background: linear-gradient(135deg, rgba(80, 140, 255, 0.18) 0%, rgba(100, 200, 255, 0.08) 100%);
        }
        .block-card.free {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.09) 0%, rgba(255, 255, 255, 0.04) 100%);
        }

        .block-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding-top: 2px;
        }

        .block-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .routine .block-dot { background: #ffa050; box-shadow: 0 0 8px rgba(255, 160, 80, 0.45); }
        .fixed .block-dot { background: #a064dc; box-shadow: 0 0 8px rgba(160, 100, 220, 0.45); }
        .rest .block-dot { background: #50c878; box-shadow: 0 0 8px rgba(80, 200, 120, 0.45); }
        .focus .block-dot { background: #50b4ff; box-shadow: 0 0 8px rgba(80, 180, 255, 0.45); }
        .free .block-dot { background: rgba(255, 255, 255, 0.75); }

        .block-line {
            width: 2px;
            flex: 1;
            min-height: 30px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 1px;
        }

        /* Hide the indicator line on the last block */
        .block-card:last-child .block-line { display: none; }

        .block-content { flex: 1; min-width: 0; }

        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 6px;
        }

        .block-title {
            font-size: 16px;
            font-weight: 650;
            color: rgba(255,255,255,0.96);
            line-height: 1.25;
        }

        .block-time {
            font-size: 12px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.55);
            white-space: nowrap;
        }

        .block-reason {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.56);
            line-height: 1.4;
            margin-bottom: 10px;
        }

        .block-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .block-tag {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.55px;
            padding: 5px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.10);
            color: rgba(255, 255, 255, 0.72);
        }

        .block-tag.energy {
            background: transparent;
            padding-left: 0;
            color: rgba(255, 255, 255, 0.50);
        }

        /* NOW pill + progress */
        .now-pill {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.4px;
            background: rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.82);
            border: 1px solid rgba(255,255,255,0.12);
        }
        .now-pill .pulse {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: rgba(255,255,255,0.65);
            box-shadow: 0 0 10px rgba(255,255,255,0.25);
            animation: nowPulse 1.2s ease-in-out infinite;
        }
        @keyframes nowPulse {
            0%,100% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.35); opacity: 0.6; }
        }

        .now-progress {
            margin-top: 10px;
            height: 6px;
            border-radius: 999px;
            background: rgba(255,255,255,0.08);
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.07);
        }
        .now-progress > div {
            height: 100%;
            width: 0%;
            border-radius: 999px;
            background: linear-gradient(90deg, rgba(255,255,255,0.55), rgba(255,255,255,0.20));
            transition: width 0.35s ease;
        }

        .block-card.current .now-pill { display: inline-flex; }
        .block-card.current .block-time { color: rgba(255,255,255,0.72); }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
            text-align: center;
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.28;
        }

        .empty-title {
            font-size: 18px;
            font-weight: 650;
            color: rgba(255, 255, 255, 0.52);
            margin-bottom: 8px;
        }

        .empty-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.32);
        }

        /* Bottom Actions (blur like tab bar) */
        .actions-container {
            padding: 12px 16px;
            padding-bottom: calc(12px + var(--safe-bottom));
            background: linear-gradient(180deg, rgba(0,0,0,0.0) 0%, rgba(0,0,0,0.72) 40%, rgba(0,0,0,0.88) 100%);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-top: 1px solid rgba(255,255,255,0.06);
            flex-shrink: 0;
        }

        .actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            flex: 1;
            padding: 16px 18px;
            border-radius: var(--radius2);
            font-family: inherit;
            font-size: 16px;
            font-weight: 650;
            border: none;
            cursor: pointer;
            transition: transform 0.18s ease, box-shadow 0.18s ease, background 0.18s ease, opacity 0.18s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            user-select: none;
            -webkit-user-select: none;
        }

        .btn:active { transform: scale(0.985); }
        .btn:disabled { opacity: 0.5; pointer-events: none; }

        .btn-primary {
            background: linear-gradient(135deg, var(--blue) 0%, var(--violet) 100%);
            color: white;
            box-shadow: 0 6px 24px rgba(100, 120, 255, 0.35);
        }
        .btn-primary:active { box-shadow: 0 3px 14px rgba(100, 120, 255, 0.30); }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.10);
            color: rgba(255, 255, 255, 0.86);
            border: 1px solid rgba(255, 255, 255, 0.14);
        }
        .btn-secondary:active { background: rgba(255, 255, 255, 0.14); }

        .btn-tertiary {
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.78);
            border: 1px solid rgba(255,255,255,0.10);
        }

        /* AI Sheet (bottom sheet) */
        .sheet-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.22s ease;
            z-index: 40;
        }
        .sheet-backdrop.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            transform: translateY(110%);
            transition: transform 0.28s cubic-bezier(0.2, 0.9, 0.2, 1);
            z-index: 45;
            padding: 10px 16px calc(14px + var(--safe-bottom));
        }
        .sheet.visible { transform: translateY(0%); }

        .sheet-card {
            border-radius: 22px;
            background: rgba(25,25,30,0.82);
            border: 1px solid rgba(255,255,255,0.12);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            box-shadow: 0 18px 70px rgba(0,0,0,0.55);
            overflow: hidden;
        }
        .sheet-handle {
            display:flex;
            justify-content:center;
            padding: 10px 0 0;
        }
        .sheet-handle > div {
            width: 44px;
            height: 5px;
            border-radius: 999px;
            background: rgba(255,255,255,0.18);
        }
        .sheet-header {
            padding: 10px 14px 12px;
            display:flex;
            align-items:flex-start;
            justify-content:space-between;
            gap: 10px;
        }
        .sheet-title {
            display:flex;
            flex-direction:column;
            gap: 2px;
        }
        .sheet-title h3 {
            font-size: 16px;
            font-weight: 700;
            color: rgba(255,255,255,0.92);
        }
        .sheet-title p {
            font-size: 12px;
            color: rgba(255,255,255,0.55);
        }
        .xbtn {
            background: rgba(255,255,255,0.10);
            border: 1px solid rgba(255,255,255,0.12);
            color: rgba(255,255,255,0.82);
            font-weight: 800;
            width: 36px;
            height: 36px;
            border-radius: 12px;
            cursor: pointer;
        }
        .xbtn:active { transform: scale(0.98); background: rgba(255,255,255,0.14); }

        .sheet-body {
            padding: 0 14px 14px;
            display:flex;
            flex-direction:column;
            gap: 10px;
        }
        .input {
            width: 100%;
            padding: 14px 12px;
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.14);
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.92);
            font-size: 15px;
            outline: none;
        }
        .input::placeholder { color: rgba(255,255,255,0.40); }

        .row {
            display:flex;
            gap: 10px;
            align-items:center;
        }
        .pill {
            display:inline-flex;
            align-items:center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.12);
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.78);
            font-size: 12px;
            font-weight: 700;
            letter-spacing: 0.3px;
            user-select:none;
        }
        .pill input { accent-color: var(--blue); }

        .sheet-actions {
            display:flex;
            gap: 10px;
            padding-top: 6px;
        }
        .sheet-actions .btn { padding: 14px 14px; font-size: 15px; }

        .hint {
            font-size: 12px;
            color: rgba(255,255,255,0.50);
            line-height: 1.35;
        }

        .toast {
            position: fixed;
            left: 50%;
            bottom: calc(88px + var(--safe-bottom));
            transform: translateX(-50%) translateY(10px);
            opacity: 0;
            transition: opacity 0.22s ease, transform 0.22s ease;
            z-index: 60;
            pointer-events: none;
        }
        .toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast > div {
            padding: 10px 12px;
            border-radius: 999px;
            background: rgba(35,35,40,0.88);
            border: 1px solid rgba(255,255,255,0.12);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            color: rgba(255,255,255,0.85);
            font-size: 12px;
            font-weight: 650;
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
        }
    </style>
</head>

<body>
<div class="app-container">

    <div class="header">
        <!-- Dynamic Island Capsule -->
        <div class="capsule-container">
            <div class="capsule idle" id="capsule">
                <div class="capsule-content">
                    <div class="capsule-dot"></div>
                    <span id="capsuleText">ORBIT</span>
                </div>
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
        </div>

        <!-- Day Summary -->
        <div class="day-summary" id="daySummary">
            <h2 id="summaryText"></h2>
            <div class="confidence" id="confidenceText"></div>
        </div>
    </div>

    <!-- Timeline -->
    <div class="timeline-container" id="timelineContainer">
        <div class="timeline" id="timeline">
            <div class="empty-state" id="emptyState">
                <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                <div class="empty-title">No plan yet</div>
                <div class="empty-subtitle">Tap "Plan my day" to get started</div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="actions-container">
        <div class="actions">
            <button class="btn btn-primary" id="planBtn" onclick="planDay()">Plan my day</button>
            <button class="btn btn-secondary" id="replanBtn" onclick="replan()" disabled>Re-plan</button>
        </div>
        <div class="actions" style="margin-top:10px;">
            <button class="btn btn-tertiary" id="aiBtn" onclick="openAISheet()">Ask ORBIT</button>
        </div>
    </div>
</div>

<!-- AI bottom sheet -->
<div class="sheet-backdrop" id="sheetBackdrop" onclick="closeAISheet()"></div>
<div class="sheet" id="aiSheet" aria-hidden="true">
    <div class="sheet-card">
        <div class="sheet-handle"><div></div></div>
        <div class="sheet-header">
            <div class="sheet-title">
                <h3>Ask ORBIT</h3>
                <p>Quick (on-device style) + optional Deep Plan (online)</p>
            </div>
            <button class="xbtn" onclick="closeAISheet()" aria-label="Close">✕</button>
        </div>
        <div class="sheet-body">
            <input class="input" id="aiInput" placeholder="e.g., I’m exhausted after school and I have math homework" />

            <div class="row" style="flex-wrap:wrap;">
                <label class="pill"><input type="checkbox" id="deepMode" /> Deep Plan (online)</label>
                <label class="pill"><input type="checkbox" id="autoScrollNow" checked /> Auto-scroll to Now</label>
            </div>

            <div class="sheet-actions">
                <button class="btn btn-secondary" onclick="runQuickAssist()">Quick Assist</button>
                <button class="btn btn-primary" onclick="runDeepAssist()">Deep Plan</button>
            </div>

            <div class="hint" id="aiHint">
                Quick Assist runs locally and works offline (heuristics). Deep Plan requires internet and an API endpoint you provide.
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast"><div id="toastText">Saved</div></div>

<script>
/* =========================
   PWA: service worker
========================= */
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
    });
}

/* =========================
   State
========================= */
let phase = 'idle'; // idle, planning, focused, adapting, success
let blocks = [];
let focusedBlockId = null;
let confidence = 0;
let daySummary = '';
let planningInterval = null;
let nowInterval = null;
let nowProgressInterval = null;

/* Persist */
const STORAGE_KEY = 'orbit.v1.lastPlan';

/* =========================
   Sample data
========================= */
const samplePlan = {
    day_summary: "A focused day with deep work and built-in recovery.",
    confidence: 0.86,
    schedule: [
        { id: "1", time: "07:00-07:30", type: "routine", title: "Wake up & get ready", energy_level: "low", reason: "Matches habitual wake time" },
        { id: "2", time: "08:00-15:00", type: "fixed", title: "School", energy_level: "variable", reason: "Fixed calendar event" },
        { id: "3", time: "15:30-16:00", type: "rest", title: "Decompression break", energy_level: "low", reason: "Low energy window after school" },
        { id: "4", time: "16:00-16:50", type: "focus", title: "Homework / deep work", energy_level: "medium", reason: "Energy recovers after short rest" },
        { id: "5", time: "17:00-18:00", type: "free", title: "Free time", energy_level: "medium", reason: "Avoids overload" }
    ]
};

const replanData = {
    day_summary: "Rebalanced: shorter deep work, longer recovery.",
    confidence: 0.78,
    schedule: [
        { id: "1", time: "07:00-07:30", type: "routine", title: "Wake up & get ready", energy_level: "low", reason: "Matches habitual wake time" },
        { id: "2", time: "08:00-15:00", type: "fixed", title: "School", energy_level: "variable", reason: "Fixed calendar event" },
        { id: "3", time: "15:30-16:15", type: "rest", title: "Decompression + snack", energy_level: "low", reason: "Extended recovery due to low energy" },
        { id: "4", time: "16:15-16:55", type: "focus", title: "Homework sprint", energy_level: "medium", reason: "Shorter block to match energy" },
        { id: "5", time: "17:00-18:00", type: "free", title: "Free time", energy_level: "medium", reason: "Avoids overload" }
    ]
};

/* =========================
   Haptics
========================= */
function haptic(style = 'light') {
    if ('vibrate' in navigator) {
        const patterns = {
            light: [10],
            medium: [18],
            heavy: [28],
            success: [10, 50, 10]
        };
        navigator.vibrate(patterns[style] || [10]);
    }
}

/* =========================
   Helpers
========================= */
function hasPlan() { return Array.isArray(blocks) && blocks.length > 0; }

function setPhase(newPhase, blockId = null) {
    phase = newPhase;
    focusedBlockId = blockId;

    const capsule = document.getElementById('capsule');
    const capsuleText = document.getElementById('capsuleText');
    const progressBar = document.getElementById('progressBar');

    capsule.className = 'capsule ' + newPhase;

    switch(newPhase) {
        case 'idle':
            capsuleText.textContent = 'ORBIT';
            progressBar.style.width = '0%';
            break;
        case 'planning':
            capsuleText.textContent = 'Planning...';
            break;
        case 'adapting':
            capsuleText.textContent = 'Updating...';
            progressBar.style.width = '0%';
            break;
        case 'success':
            capsuleText.textContent = 'Ready ✓';
            progressBar.style.width = '0%';
            haptic('success');
            break;
        case 'focused':
            capsuleText.textContent = 'Focus Mode';
            break;
    }

    updateBlockStyles();
    updateNowHighlightAndProgress();
}

function updateBlockStyles() {
    document.querySelectorAll('.block-card').forEach(card => {
        const id = card.dataset.id;
        card.classList.remove('dimmed', 'focused-block');

        if (phase === 'focused' && focusedBlockId) {
            if (id === focusedBlockId) card.classList.add('focused-block');
            else card.classList.add('dimmed');
        }
    });
}

function exitFocusToBaseline() { setPhase('idle', null); }

/* time parsing */
function parseMinutes(hhmm) {
    const [h, m] = String(hhmm).split(':').map(n => parseInt(n, 10));
    if (Number.isNaN(h) || Number.isNaN(m)) return null;
    return h * 60 + m;
}
function timeRangeToMinutes(rangeStr) {
    const parts = String(rangeStr || '').split('-');
    if (parts.length !== 2) return null;
    const start = parseMinutes(parts[0].trim());
    const end = parseMinutes(parts[1].trim());
    if (start === null || end === null) return null;
    return { start, end };
}
function getNowMinutes() {
    const d = new Date();
    return d.getHours() * 60 + d.getMinutes();
}
function findCurrentBlockIdAndRange() {
    if (!hasPlan()) return { id: null, range: null };
    const now = getNowMinutes();
    for (const b of blocks) {
        const r = timeRangeToMinutes(b.time);
        if (!r) continue;
        const crosses = r.end < r.start;
        const inRange = crosses
            ? (now >= r.start || now < r.end)
            : (now >= r.start && now < r.end);
        if (inRange) return { id: b.id, range: r };
    }
    return { id: null, range: null };
}

function updateNowHighlightAndProgress() {
    const { id: currentId, range } = findCurrentBlockIdAndRange();

    document.querySelectorAll('.block-card').forEach(card => {
        const id = card.dataset.id;
        if (currentId && id === currentId) card.classList.add('current');
        else card.classList.remove('current');

        // progress bar inside card
        const bar = card.querySelector('.now-progress > div');
        if (!bar) return;

        if (currentId && id === currentId && range) {
            const now = getNowMinutes();
            const crosses = range.end < range.start;
            let duration, elapsed;
            if (!crosses) {
                duration = Math.max(1, (range.end - range.start));
                elapsed = Math.min(duration, Math.max(0, now - range.start));
            } else {
                // cross-midnight: treat as end+1440
                const end2 = range.end + 1440;
                const now2 = (now < range.end) ? now + 1440 : now;
                duration = Math.max(1, end2 - range.start);
                elapsed = Math.min(duration, Math.max(0, now2 - range.start));
            }
            const pct = Math.max(0, Math.min(1, elapsed / duration));
            bar.style.width = (pct * 100).toFixed(1) + '%';
        } else {
            bar.style.width = '0%';
        }
    });
}

function startNowTicker() {
    if (nowInterval) clearInterval(nowInterval);
    updateNowHighlightAndProgress();
    nowInterval = setInterval(updateNowHighlightAndProgress, 30_000);

    if (nowProgressInterval) clearInterval(nowProgressInterval);
    // smoother progress for the current block
    nowProgressInterval = setInterval(updateNowHighlightAndProgress, 5_000);
}

function scrollToNowIfEnabled() {
    const enabled = document.getElementById('autoScrollNow') ? document.getElementById('autoScrollNow').checked : true;
    if (!enabled) return;
    const current = document.querySelector('.block-card.current');
    if (current) current.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/* =========================
   Render
========================= */
function renderTimeline() {
    const timeline = document.getElementById('timeline');
    const daySummaryEl = document.getElementById('daySummary');
    const summaryText = document.getElementById('summaryText');
    const confidenceText = document.getElementById('confidenceText');

    if (!hasPlan()) {
        timeline.innerHTML = `
            <div class="empty-state">
                <svg class="empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M12 6v6l4 2"/>
                </svg>
                <div class="empty-title">No plan yet</div>
                <div class="empty-subtitle">Tap "Plan my day" to get started</div>
            </div>
        `;
        daySummaryEl.classList.remove('visible');
        return;
    }

    summaryText.textContent = daySummary;
    confidenceText.textContent = `${Math.round(confidence * 100)}% confidence`;
    daySummaryEl.classList.add('visible');

    timeline.innerHTML = blocks.map((block) => `
        <div class="block-card ${block.type}" data-id="${block.id}" onclick="toggleFocus('${block.id}')">
            <div class="block-indicator">
                <div class="block-dot"></div>
                <div class="block-line"></div>
            </div>
            <div class="block-content">
                <div class="block-header">
                    <div class="block-title">${escapeHtml(block.title)}</div>
                    <div class="block-time">
                        <span class="now-pill"><span class="pulse"></span>NOW</span>
                        ${escapeHtml(block.time)}
                    </div>
                </div>
                <div class="block-reason">${escapeHtml(block.reason)}</div>
                <div class="block-tags">
                    <span class="block-tag">${escapeHtml(block.type)}</span>
                    <span class="block-tag energy">${escapeHtml(block.energy_level)} energy</span>
                </div>
                <div class="now-progress"><div></div></div>
            </div>
        </div>
    `).join('');

    // Animate in
    const cards = document.querySelectorAll('.block-card');
    cards.forEach((card, i) => {
        setTimeout(() => {
            card.classList.add('visible');
            if (i === 0) haptic('light');
        }, i * 70);
    });

    updateBlockStyles();
    updateNowHighlightAndProgress();
}

function escapeHtml(s) {
    return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

/* =========================
   Focus
========================= */
function toggleFocus(blockId) {
    haptic('light');
    if (!hasPlan()) { setPhase('idle'); return; }

    if (phase === 'focused' && focusedBlockId === blockId) exitFocusToBaseline();
    else setPhase('focused', blockId);
}

/* =========================
   Planning animation
========================= */
function beginPlanning() {
    setPhase('planning');
    const progressBar = document.getElementById('progressBar');

    const startTime = Date.now();
    if (planningInterval) clearInterval(planningInterval);

    planningInterval = setInterval(() => {
        const elapsed = (Date.now() - startTime) / 1000;
        const progress = Math.min(0.85, 1 - Math.exp(-elapsed * 1.2));
        progressBar.style.width = (progress * 100) + '%';
    }, 33);
}

function reconcileFocusAfterPlanChange() {
    if (phase !== 'focused') return;
    if (!focusedBlockId) return;

    const stillExists = blocks.some(b => b.id === focusedBlockId);
    if (!stillExists) {
        const { id } = findCurrentBlockIdAndRange();
        if (id) setPhase('focused', id);
        else exitFocusToBaseline();
    } else {
        updateBlockStyles();
    }
}

function persistPlan() {
    try {
        const payload = { daySummary, confidence, blocks, ts: Date.now() };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    } catch {}
}

function restorePlan() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const obj = JSON.parse(raw);
        if (!obj || !Array.isArray(obj.blocks)) return false;
        daySummary = obj.daySummary || '';
        confidence = typeof obj.confidence === 'number' ? obj.confidence : 0;
        blocks = obj.blocks;
        return true;
    } catch {
        return false;
    }
}

function applyPlan(data) {
    if (planningInterval) clearInterval(planningInterval);

    setPhase('adapting');

    daySummary = data.day_summary;
    confidence = data.confidence;
    blocks = data.schedule;

    persistPlan();

    setTimeout(() => {
        renderTimeline();
        reconcileFocusAfterPlanChange();

        setTimeout(() => {
            setPhase('success');
            document.getElementById('replanBtn').disabled = false;

            setTimeout(() => {
                setPhase('idle');
                scrollToNowIfEnabled();
            }, 750);
        }, 360);
    }, 260);
}

/* =========================
   Buttons
========================= */
function planDay() {
    haptic('medium');
    document.getElementById('planBtn').disabled = true;

    beginPlanning();
    setTimeout(() => {
        applyPlan(samplePlan);
        document.getElementById('planBtn').disabled = false;
    }, 1200);
}

function replan() {
    haptic('medium');
    document.getElementById('replanBtn').disabled = true;

    document.querySelectorAll('.block-card').forEach(card => {
        card.style.opacity = '0.3';
        card.style.transform = 'translateY(4px)';
    });

    beginPlanning();
    setTimeout(() => {
        applyPlan(replanData);
        document.getElementById('replanBtn').disabled = false;
    }, 1050);
}

/* =========================
   Hybrid AI (Local quick assist + Online deep plan hook)
========================= */
function openAISheet() {
    haptic('light');
    document.getElementById('sheetBackdrop').classList.add('visible');
    const sheet = document.getElementById('aiSheet');
    sheet.classList.add('visible');
    sheet.setAttribute('aria-hidden', 'false');
    setTimeout(() => document.getElementById('aiInput').focus(), 150);
}

function closeAISheet() {
    document.getElementById('sheetBackdrop').classList.remove('visible');
    const sheet = document.getElementById('aiSheet');
    sheet.classList.remove('visible');
    sheet.setAttribute('aria-hidden', 'true');
}

function toast(msg) {
    const t = document.getElementById('toast');
    document.getElementById('toastText').textContent = msg;
    t.classList.add('visible');
    setTimeout(() => t.classList.remove('visible'), 1600);
}

/* Quick Assist: tiny local planner heuristics (offline) */
function runQuickAssist() {
    haptic('light');
    const text = (document.getElementById('aiInput').value || '').trim().toLowerCase();

    // Very small “intent” extraction (offline)
    const tired = /(tired|exhausted|burnt|burned|sleepy|low energy)/.test(text);
    const bigHomework = /(homework|study|studying|assignment|math|essay|project)/.test(text);
    const anxious = /(anxious|stressed|overwhelmed)/.test(text);

    // Build a plan using your existing sample as baseline but adapt durations/reasons
    const base = JSON.parse(JSON.stringify(samplePlan));

    if (tired || anxious) {
        base.day_summary = "Gentler plan: protect recovery first, then focus in shorter sprints.";
        base.confidence = 0.80;
        base.schedule = [
            { id: "1", time: "07:00-07:30", type: "routine", title: "Wake up & get ready", energy_level: "low", reason: "Keep the morning predictable" },
            { id: "2", time: "08:00-15:00", type: "fixed", title: "School", energy_level: "variable", reason: "Fixed calendar block" },
            { id: "3", time: "15:30-16:20", type: "rest", title: "Decompression + snack", energy_level: "low", reason: "You said energy is low—extend recovery" },
            { id: "4", time: "16:20-16:55", type: "focus", title: bigHomework ? "Homework sprint" : "One important task", energy_level: "medium", reason: "Short sprint to avoid overload" },
            { id: "5", time: "17:00-18:00", type: "free", title: "Free time", energy_level: "medium", reason: "Leave buffer to reset" }
        ];
    } else if (bigHomework) {
        base.day_summary = "Homework-forward plan: deep work while energy is steady, then buffer.";
        base.confidence = 0.84;
        base.schedule = [
            { id: "1", time: "07:00-07:30", type: "routine", title: "Wake up & get ready", energy_level: "low", reason: "Consistent start" },
            { id: "2", time: "08:00-15:00", type: "fixed", title: "School", energy_level: "variable", reason: "Fixed calendar event" },
            { id: "3", time: "15:30-16:00", type: "rest", title: "Reset break", energy_level: "low", reason: "Transition out of school mode" },
            { id: "4", time: "16:00-17:10", type: "focus", title: "Homework / deep work", energy_level: "medium", reason: "Use the best post-break window" },
            { id: "5", time: "17:10-18:00", type: "free", title: "Free time", energy_level: "medium", reason: "Cooldown and flexibility" }
        ];
    }

    // Apply
    closeAISheet();
    beginPlanning();
    setTimeout(() => applyPlan(base), 650);
    toast("Quick Assist applied");
}

/* Deep Assist: requires your own API endpoint (proxy to any LLM you want)
   - For security you should NOT put an API key in this file.
*/
async function runDeepAssist() {
    haptic('medium');

    const deepChecked = document.getElementById('deepMode').checked;
    if (!deepChecked) {
        // If user tapped Deep Plan but didn't enable online mode, guide them.
        toast("Enable “Deep Plan (online)” first");
        return;
    }

    const prompt = (document.getElementById('aiInput').value || '').trim();
    if (!prompt) {
        toast("Type a request first");
        return;
    }

    // TODO: Set this to YOUR backend endpoint
    const ORBIT_AI_ENDPOINT = ""; // e.g. "https://yourdomain.com/orbit-plan"

    if (!ORBIT_AI_ENDPOINT) {
        toast("Deep Plan needs an API endpoint");
        document.getElementById('aiHint').textContent =
            "Set ORBIT_AI_ENDPOINT in the code to your server. The server should return {day_summary, confidence, schedule:[...]}";
        return;
    }

    closeAISheet();
    document.getElementById('planBtn').disabled = true;
    beginPlanning();

    try {
        const res = await fetch(ORBIT_AI_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                prompt,
                // You can also send: existing plan, current time, user prefs, etc.
                current_time: new Date().toISOString(),
                existing_plan: hasPlan() ? { day_summary: daySummary, confidence, schedule: blocks } : null
            })
        });

        if (!res.ok) throw new Error("bad status");
        const data = await res.json();

        // Basic shape check
        if (!data || !Array.isArray(data.schedule)) throw new Error("bad payload");

        applyPlan(data);
        toast("Deep Plan applied");
    } catch (e) {
        // fallback: quick assist
        toast("Deep Plan failed — using Quick Assist");
        runQuickAssist();
    } finally {
        document.getElementById('planBtn').disabled = false;
    }
}

/* =========================
   Init
========================= */
document.addEventListener('DOMContentLoaded', () => {
    const restored = restorePlan();
    if (restored) {
        document.getElementById('replanBtn').disabled = false;
    }

    renderTimeline();
    startNowTicker();

    // Idle capsule pulse
    setInterval(() => {
        if (phase === 'idle') {
            const capsule = document.getElementById('capsule');
            const intensity = 0.5 + 0.5 * Math.sin(Date.now() / 1000 * 1.3);
            capsule.style.boxShadow = `0 6px ${22 + intensity * 10}px rgba(255, 255, 255, ${0.04 + intensity * 0.04})`;
        }
    }, 60);
});

/* double tap zoom prevention (safe-ish) */
(function preventDoubleTapZoom() {
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) event.preventDefault();
        lastTouchEnd = now;
    }, { passive: false });
})();

/* allow Esc to close sheet on desktops */
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAISheet();
});
</script>
</body>
</html>
